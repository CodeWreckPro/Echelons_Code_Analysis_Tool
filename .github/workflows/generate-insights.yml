name: Generate Insights

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "Target public GitHub repo URL (e.g., https://github.com/owner/repo.git)"
        required: true
        type: string

permissions:
  contents: write  # needed to push to gh-pages via GITHUB_TOKEN

jobs:
  generate:
    runs-on: ubuntu-latest
    concurrency:
      group: insights-${{ inputs.repo_url }}
      cancel-in-progress: false

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Parse owner/repo from input
        id: parse
        run: |
          URL="${{ inputs.repo_url }}"
          URL="${URL%.git}"
          URL="${URL%/}"
          OWNER=$(echo "$URL" | awk -F'/' '{print $(NF-1)}')
          REPO=$(echo "$URL" | awk -F'/' '{print $NF}')
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Clone target repo (full history)
        run: |
          git clone "https://github.com/${{ steps.parse.outputs.owner }}/${{ steps.parse.outputs.repo }}.git" target-repo
          cd target-repo
          # If the clone is shallow, unshallow to get full history
          git fetch --unshallow || true

      - name: Set PYTHONPATH for app imports
        run: echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Generate insights JSON
        run: |
          mkdir -p docs/insights/${{ steps.parse.outputs.owner }}
          python ci/generate_insights.py \
            --repo-path "$GITHUB_WORKSPACE/target-repo" \
            --output-path "docs/insights/${{ steps.parse.outputs.owner }}/${{ steps.parse.outputs.repo }}.json"

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com